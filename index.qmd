---
title: "Spatial Analysis Dashboard"
subtitle: "Chicago Health Indicators"
format: 
  dashboard:
    theme: flatly
    orientation: rows
    expandable: true
    scrolling: false
    embed-resources: true
editor_options: 
  chunk_output_type: console
---

```{r}
#| label: Activate necessary R packages
#| eval: true
#| echo: false

library(dplyr) # data wrangling with pipe syntax
library(tidyverse) # data wrangling
library(sf) # simple features geometry data
library(spdep) # spatial dependence for spatial analysis
library(purrr) # functional programming
library(tidyr) # data wrangling
library(leaflet) # interactive map making
library(leaflet.extras) # extra functionality for leaflet maps
library(plotly) # make interactive charts
library(healthatlas) # health atlas package
library(rgeoda) # spatial analysis package
library(corrplot) # correlation plot
library(broom) # statistical objects

# Define dashboard data file path
file_path <- "data/dashboard_data.RData"

# Load dashboard data from RData file if it exists
if (file.exists(file_path)) {
  load(file_path)
}

```


```{r}
#| label: Import data from Chicago Health Atlas, create RData file
#| eval: false
#| echo: false

# set the current atlas to the Chicago Health Atlas using the provided URL
ha_set("chicagohealthatlas.org")

# import community area boundaries from chicago data portal
community_areas <- st_read("https://data.cityofchicago.org/resource/igwz-8jzy.geojson") %>% 
  mutate(geoid = as.numeric(area_numbe),
         name = str_to_title(community)) %>%
  select(geoid, name)

# import city of chicago boundary from chicago data portal
chicago_boundary <- st_read("https://data.cityofchicago.org/resource/qqq8-j68g.geojson") %>% 
  select(name)

## BEGIN EDIT 
# define topic, period, and population keys to extract latest data from health atlas
# make sure that the indicators in the topic_keys_list and topic_cols_list are in the same order.
topic_keys_list = c("HCSDIAP", "VRLE", "HCSPCPP", "FAI")
topic_cols_list = c("diabetes_rate", "life_expect","pcp_rate","food_insecure")
period_keys_list = c("2023-2024", "2019-2023", "2020")
## END EDIT

# create a rename to rename topics to more descriptive names
rename_map_names <- setNames(topic_cols_list, topic_keys_list)

# Use the coverage information to filter and select specific data year
# select and rename essential columns
community_area_data_table <- ha_data(
  topic_key = topic_keys_list,
  population_key = "",
  # full population
  period_key = period_keys_list,
  layer_key = "neighborhood"
) %>%
  mutate(topic_key = recode(topic_key, !!!rename_map_names)) %>%
  select(geoid, topic_key, period_key, value) %>%
  ungroup() %>%
  pivot_wider(names_from = c(topic_key, period_key),
              values_from = value) %>%
  rename_with( ~ sub("_[^_]+$", "", .x), -geoid) %>%
  mutate(across(2:5, ~ dplyr::ntile(.x, 5), .names = "{.col}_q5")) %>%
  mutate(across(6:9, ~ factor(
    .x,
    levels = 1:5,
    labels = c("lowest", "low", "medium", "high", "highest"),
    ordered = TRUE
  ))) %>%
  mutate(geoid = as.numeric(str_replace(geoid, pattern = "1714000-", ""))) %>%
  left_join(community_areas, by = "geoid") %>%
  st_as_sf()

# save dashboard data file
save(community_area_data_table, community_areas, chicago_boundary, file = "data/dashboard_data.RData")

```

```{r}
#| label: Functions for creating custom maps and charts
#| eval: true
#| echo: false

# Function for creating custom choropleth maps using variable input
fx_custom_choropleth_map <- function(var, map_color, map_title) {
  # specify quintile variable name
  var_q5 <- paste0(var, "_q5")
  
  # create color palette
  # specify value column
  pal <- colorFactor(
    palette = map_color,
    domain = (community_area_data_table[[var_q5]]),
    # EDIT HERE
    na.color = "#CCCCCC"
  )
  
  # configure labels
  labels <- sprintf(
    "<strong>%s</strong><br/>
  Rate: %0.1f",
  community_area_data_table$name,
  community_area_data_table[[var]]
  ) %>% # EDIT HERE (rates, not quintiles)
    lapply(htmltools::HTML)
  
  # add polygons to leaflet map
  leaflet(community_area_data_table) %>%
    addProviderTiles(providers$CartoDB.Positron, group = "Positron (minimal)") %>%
    addPolygons(
      fillColor = ~ pal(get(var_q5)),
      # EDIT HERE
      weight = 0.5,
      opacity = 0.75,
      color = "white",
      fillOpacity = 0.75,
      label = ~ labels
    ) %>%
    addPolylines(
      data = chicago_boundary,
      stroke = TRUE,
      weight = 2,
      opacity = 1,
      fillOpacity = 0,
      color = "Black",
      group = "City of Chicago"
    ) %>%
    addLegend(
      position = "bottomleft",
      pal = pal,
      values = ~ get(var_q5),
      # EDIT HERE
      title = map_title,
      # EDIT HERE
      opacity = 1
    ) %>%
    addResetMapButton()
}

# Function for creating custom LISA map using variable input
fx_custom_lisa_map <- function(var) {
  # remove NAs from data table
  community_area_data_table_lisa <- community_area_data_table %>%
    drop_na(all_of(var))
  
  # calculate LISA scores using queen contiguity weights
  w.queen <- queen_weights(community_area_data_table_lisa)
  
  # compute LISA scores
  lisa.queen <- local_moran(w.queen, community_area_data_table_lisa[var], permutations = 999)
  
  # create color, label, and cluster objects for plotting
  lisa_clusters <- lisa_clusters(lisa.queen)
  lisa_colors <- lisa_colors(lisa.queen)
  lisa_labels <- lisa_labels(lisa.queen)
  lisa_categories <- c(0:6) %>%
    as.data.frame() %>%
    bind_cols(lisa_labels, lisa_colors) %>%
    rename(
      cluster_number = 1,
      cluster_label = 2,
      cluster_color = 3
    )
  
  # add LISA scores to community area table
  aLISA_table <- community_area_data_table_lisa %>%
    bind_cols(lisa_cluster = lisa_clusters) %>%
    left_join(lisa_categories, by = c("lisa_cluster" = "cluster_number"))
  
  # create palette for map
  palette <- aLISA_table %>%
    st_drop_geometry() %>%
    distinct(lisa_cluster, cluster_label, cluster_color) %>%
    arrange(lisa_cluster)
  
  # configure labels
  labels <- sprintf(
    "<strong>%s</strong><br/>
  Cluster type: %s<br/>
  Value: %0.1f",
  aLISA_table$name,
  aLISA_table$cluster_label,
  aLISA_table[[var]]
  ) %>%
    lapply(htmltools::HTML)
  
  # add polygons to leaflet map
  leaflet(aLISA_table) %>%
    addProviderTiles(providers$CartoDB.Positron, group = "Positron (minimal)") %>%
    addPolygons(
      fillColor = ~ cluster_color,
      # EDIT HERE
      weight = 0.5,
      opacity = 0.75,
      color = "white",
      fillOpacity = 0.75,
      label = labels
    ) %>%
    addPolylines(
      data = chicago_boundary,
      stroke = TRUE,
      weight = 2,
      opacity = 1,
      fillOpacity = 0,
      color = "Black",
      group = "City of Chicago"
    ) %>%
    addLegend(
      position = "bottomleft",
      colors = palette$cluster_color,
      # vector of hex codes
      labels = palette$cluster_label,
      title = "Cluster Type",
      opacity = 1
    )  %>%
    addResetMapButton()
}
```

# Mortality
## Row {height=10%}

The mortality indicators, adult diabetes rate and life expectancy, were selected because they reflect core health outcomes that reveal significant disparities across Chicago neighborhoods. Diabetes is a chronic illness that can be (in some cases) prevented, and be a very manageable disease with adequate healthcare. While life expectancy provides a broad measure of longevity.  Mapping these indicators shows clear spatial patterns of inequity, identifying areas where poor health outcomes are concentrated. 

## Row {height=60%}
### Column
```{r}
#| label: Diabetes Map 1
#| title: Rate of Diabetes, 2023-24 # EDIT HERE
#| eval: true

# Create custom choropleth map using specified parameters
# BEGIN EDITING
var <- "diabetes_rate" # specify variable to map
map_color <- "Reds" # specify color range for map
map_title <- "Diabetes Rate" # specify map title
# STOP EDITING

fx_custom_choropleth_map(var, map_color, map_title)

```

### Column
```{r}
#| label: Life Expectancy
#| title: Life Expectancy, 2020  # EDIT HERE
#| eval: true

# Create custom choropleth map using specified parameters
# BEGIN EDITING
var <- "life_expect" # specify variable to map
map_color <- "Purples" # specify color range for map
map_title <- "Life Expectancy" # specify map title
# STOP EDITING

fx_custom_choropleth_map(var, map_color, map_title)

```

## Row {height=30%}
### Column
```{r}
#| label: Diabetes Histogram 1
#| title: Diabetes Histogram
#| eval: true

df <- community_area_data_table %>%
  st_set_geometry(NULL) %>%
  transmute(diabetes_rate = as.numeric(diabetes_rate)) %>% # EDIT HERE (two values)
  filter(is.finite(diabetes_rate)) # EDIT HERE

plot_ly(
  df,
  x = ~diabetes_rate, # EDIT HERE
  type = "histogram",
  nbinsx = 20,
  marker = list(color = "Red",
                line = list(color = "rgba(0,0,0,0.25)", width = 0.5))
) %>%
  layout(
    xaxis = list(title = "Rate (per 100,000)"),
    yaxis = list(title = "Count"),
    bargap = 0.05,
    showlegend = FALSE
  )

```

### Column
```{r}
#| label: Life Expectancy Histogram 2
#| title: Life Expectancy Histogram
#| eval: true


df <- community_area_data_table %>%
  st_set_geometry(NULL) %>%
  transmute(life_expect = as.numeric(life_expect)) %>% # EDIT HERE (two values)
  filter(is.finite(life_expect)) # EDIT HERE

plot_ly(
  df,
  x = ~life_expect, # EDIT HERE
  type = "histogram",
  nbinsx = 20,
  marker = list(color = "Purple",
                line = list(color = "rgba(0,0,0,0.25)", width = 0.5))
) %>%
  layout(
    xaxis = list(title = "Age"),
    yaxis = list(title = "Count"),
    bargap = 0.05,
    showlegend = FALSE
  )

```

# SDOH
## Row {height=10%}

The SDOH indicators—primary care provider rate and food insecurity—capture key social and economic conditions that influence community health. The primary care provider rate reflects access to routine and preventive care, while food insecurity reflects neighborhoods with limited or uncertain access to adequate food. Mapping these measures shows where structural barriers are concentrated across Chicago. 

## Row {height=60%}

### Column
```{r}
#| label: SDOH Map 1
#| title: Primary Care Provider Rate, 2023-2024 # EDIT HERE
#| eval: true

# Create custom choropleth map using specified parameters
# BEGIN EDITING
var <- "pcp_rate" # specify variable to map
map_color <- "Oranges" # specify color range for map
map_title <- "Primary Care Physician Rate" # specify map title
# STOP EDITING

fx_custom_choropleth_map(var, map_color, map_title)

```

### Column
```{r}
#| label: SDOH Map 2
#| title: "Food Insecurity Rate, 2020" # EDIT HERE
#| eval: true

# Create custom choropleth map using specified parameters
# BEGIN EDITING
var <- "food_insecure" # specify variable to map
map_color <- "Greens" # specify color range for map
map_title <- "Food Insecurity" # specify map title
# STOP EDITING

fx_custom_choropleth_map(var, map_color, map_title)

```

## Row {height=30%}
### Column
```{r}
#| label: Histogram SDOH 1
#| title: Primary Care Provider Histogram
#| eval: true

df <- community_area_data_table %>%
  st_set_geometry(NULL) %>%
  transmute(pcp_rate = as.numeric(pcp_rate)) %>% # EDIT HERE  (two values)
  filter(is.finite(pcp_rate)) # EDIT HERE

plot_ly(
  df,
  x = ~pcp_rate, # EDIT HERE
  type = "histogram",
  nbinsx = 20,
  marker = list(color = "#A63603",
                line = list(color = "#FDBE85", width = 0.5))
) %>%
  layout(
    xaxis = list(title = "Primary Care Rate"), # EDIT HERE
    yaxis = list(title = "Count"),
    bargap = 0.05,
    showlegend = FALSE
  )



```

### Column
```{r}
#| label: Histogram SDOH 2
#| title: Food Insecurity Histogram
#| eval: true


df <- community_area_data_table %>%
  st_set_geometry(NULL) %>%
  transmute(food_insecure = as.numeric(food_insecure)) %>% # EDIT HERE (two values)
  filter(is.finite(food_insecure)) # EDIT HERE

plot_ly(
  df,
  x = ~food_insecure, # EDIT HERE
  type = "histogram",
  nbinsx = 20,
  marker = list(color = "Green",
                line = list(color = "#FDBE85", width = 0.5))
) %>%
  layout(
    xaxis = list(title = "Food Insecurity Rate (%)"), # EDIT HERE
    yaxis = list(title = "Count"),
    bargap = 0.05,
    showlegend = FALSE
  )

```

# Spatial Analysis

```{r}
#| label: Data preparation
#| eval: true
#| echo: false

# select relevant variables for spatial analysis
vars <- c("diabetes_rate", "life_expect", "pcp_rate", "food_insecure") # EDIT HERE

```

## Row {height=20%}
The following analyses include a bivariate correlation and Global Moran’s I plot that examine statistical relationships between the selected health outcome and social determinants of health (SDOH) indicators. Additionally, Local Indicators of Spatial Association (LISA) maps are presented for each variable to visualize areas where statistically significant spatial clustering occurs. Together, these analyses help identify both the strength of associations between indicators and the geographic patterns that may reveal underlying spatial inequities across the study area.

## Row {height=80%}
### Column {.tabset}
```{r}
#| label: Bivariate Correlations (Pearson)
#| title: "Bivariate Correlation Matrix"
#| eval: true
#| echo: false

# calculate bivariate correlations
correlation_matrix <- community_area_data_table %>% 
  st_drop_geometry() %>%
  select(all_of(vars)) %>%
  cor(use = "pairwise.complete.obs", method = "pearson")

# create (non-spatial) correlation plot
correlation_plot <- corrplot(correlation_matrix, 
method="number", 
col=c("#2c7bb6","white"), 
order="hclust", 
bg="lightgrey", 
tl.col = "grey")

```

```{r}
#| label: Global Moran's I
#| title: Global Moran's I
#| eval: true
#| echo: false

# generate neighborhood index and weights (Queen level)
nb <- poly2nb(st_geometry(community_area_data_table))
lw <- nb2listw(nb, style = "W", zero.policy = TRUE)

# calculate Global Moran's I for each variable using queen weights matrix
global_moran_tbl <- tibble(variable = vars) %>%
  mutate(test = map(variable, ~ moran.test(community_area_data_table[[.x]], lw,
                                           randomisation = TRUE,
                                           alternative = "greater",
                                           na.action = na.exclude,
                                           zero.policy = TRUE))) %>%
  mutate(tidy = map(test, tidy)) %>%
  select(variable, tidy) %>%
  unnest_wider(tidy)

# create a plotly chart showing Global Mornan's I results
plot_ly(global_moran_tbl,
        x = ~reorder(variable, estimate1),
        y = ~estimate1,
        type = "bar",
        color = ~ifelse(p.value < 0.05, "Significant", "Not significant"),
        colors = c("Significant" = "#2c7bb6", "Not significant" = "lightgray"),
        hoverinfo = "text",
        text = ~paste(
          "<b>", variable, "</b><br>",
          "Moran’s I: ", round(estimate1, 3), "<br>",
          "Expected: ", round(estimate2, 3), "<br>",
          "p = ", signif(p.value, 3)
        )) %>%
  layout(
    xaxis = list(title = ""),
    yaxis = list(title = "Global Moran’s I")
  )

```

### Column {.tabset}
```{r}
#| title: All Mortality
#| eval: true
#| echo: false

# Create custom LISA map using specified variable
var = "diabetes_rate"  # EDIT HERE: choose one variable from vars

# Execute custom LISA map function
fx_custom_lisa_map(var) 

```

```{r}
#| title: Life Expectancy
#| eval: true
#| echo: false

# Create custom LISA map using specified variable
var = "life_expect"  # EDIT HERE: choose one variable from vars

# Execute custom LISA map function
fx_custom_lisa_map(var) 

```

```{r}
#| title: Primary Care Physician Rate
#| eval: true
#| echo: false

# Create custom LISA map using specified variable
var = "pcp_rate"  # EDIT HERE: choose one variable from vars

# Execute custom LISA map function
fx_custom_lisa_map(var) 

```

```{r}
#| title: Food Insecurity
#| eval: true
#| echo: false

# Create custom LISA map using specified variable
var = "food_insecure"  # EDIT HERE: choose one variable from vars

# Execute custom LISA map function
fx_custom_lisa_map(var) 


```

# Summary of Findings
## Row {height=100%}

The public health outcomes are diabetes rate and life expectancy, and the social determinant of health are the rate of individuals which have a primary care provider and the rate of individuals facing food insecurity. Diabetes rate and primary care provider rate were collected by the City of Chicago through a Healthy Chicago survey. Life expectancy data is provided by the Illinois Department of Public Health’s death records and Food insecurity is from a Feeding America projection. The indicators are aggregated by the Chicago Health Atlas.  

Across the indicators displayed on the dashboard, clear geographic patterns emerge that show a persistent North and South /Southwest divide in health outcomes across Chicago. Life expectancy, primary care access and diabetes prevalence each display strong spatial gradients. Neighborhoods on the North and Northwest Sides consistently fall into the highest categories of life expectancy and provider usage, while showing the lowest rates of food insecurity and chronic disease. 

In contrast, large portions of the South and Southwest Sides appear in the highest-risk categories for food insecurity and diabetes and in the lowest categories for life expectancy and primary care access. These patterns are reinforced by the histograms, which show wide variation across tracts, and by the LISA mortality map, which identifies significant High-High mortality clusters largely in the South and Low-Low mortality clusters along the North Lakefront. 

The spatial analyses further illustrate these disparities. Global Moran’s I values show that food insecurity and life expectancy are highly clustered, while diabetes and primary care access show moderate to weaker clustering. Local Moran’s I identifies the specific neighborhoods where those clusters occur, consistent concentrations of elevated mortality on the Southside. 


```{r}
#| label: write dataset to shapefile
#| eval: false

# use for writing data to shapefile for Exercise #3
st_write(community_area_data_table, "data/community_area_data_table.shp")
```


